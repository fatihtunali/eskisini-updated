<!doctype html>
<html lang="tr">
<head>
  <!-- Google Fonts: Inter (TR uyumlu, latin-ext) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap&subset=latin-ext"
    rel="stylesheet">

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Favorilerim | Eskisini Ver Yenisini Al</title>
  <link rel="stylesheet" href="css/styles.css">
</head>

<body>
  <div data-include="partials/header.html"></div>

  <main class="container section">
    <h1>Favorilerim</h1>
    <div id="favlist" class="grid three"></div>
  </main>

  <div data-include="partials/footer.html"></div>

  <!-- JS (doğru sıra) -->
  <script src="js/partials.js"></script>
  <script src="js/config.js"></script>
  <script src="js/ui.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/header.js"></script>
  <script src="js/session.js"></script>
  <script src="js/fav.js"></script>   <!-- kalp/toggle için gerekli -->
  <script src="js/buy.js"></script>

  <script>
  (function(){
    const API = (window.APP && APP.API_BASE) || '';
    const $   = (s,r=document)=>r.querySelector(s);
    const esc = s => String(s ?? '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));

    function redirectToLogin(){
      const u = new URL('/login.html', location.origin);
      u.searchParams.set('redirect', location.pathname + location.search);
      location.href = u.toString();
    }

    const fmtPrice = (minor, cur='TRY') =>
      `${((Number(minor)||0)/100).toLocaleString('tr-TR',{maximumFractionDigits:2})} ${esc(cur)}`;

    function cardHTML(x){
      const href = x.slug
        ? `/listing.html?slug=${encodeURIComponent(x.slug)}`
        : `/listing.html?id=${encodeURIComponent(x.listing_id)}`;
      const img  = x.thumb_url || x.cover || '/assets/placeholder.png';
      const hasPrice = typeof x.price_minor === 'number';
      const priceStr = hasPrice ? fmtPrice(x.price_minor, x.currency||'TRY') : '';

      // fav-count varsa gösterelim; yoksa 0
      const favCount = Number.isFinite(x.favorites_count) ? x.favorites_count : 0;
      const favBtn   = (window.FAV && x.listing_id)
        ? FAV.favButtonHTML(x.listing_id, true)  // favorilerde zaten aktif
        : '';

      return `
        <article class="card product-card" data-listing-id="${x.listing_id}">
          <div class="media">
            <a class="thumb" href="${href}">
              <img loading="lazy" src="${img}" alt="${esc(x.title||'')}"
                   onerror="this.src='/assets/placeholder.png';this.onerror=null">
            </a>
          </div>
          <div class="pad">
            <h3 class="p-title"><a href="${href}">${esc(x.title||'')}</a></h3>
            ${priceStr ? `<div class="p-price">${priceStr}</div>` : ''}
            <div class="actions" style="display:flex;align-items:center;gap:10px;margin-top:8px">
              <a class="btn" href="${href}">Görüntüle</a>
              <!-- Kalp butonu + sayaç -->
              <span class="fav-count">${favCount}</span>
              ${favBtn}
            </div>
          </div>
        </article>
      `;
    }

    async function load(){
      const root = $('#favlist');
      root.innerHTML = '<div class="pad">Yükleniyor…</div>';

      try{
        const res = await fetch(`${API}/api/favorites/my`, {
          credentials:'include',
          headers:{'Accept':'application/json','Cache-Control':'no-store'},
          cache:'no-store'
        });
        if (res.status === 401) { redirectToLogin(); return; }
        if (!res.ok) throw new Error('HTTP '+res.status);

        const data = await res.json();
        const items = data.items || [];

        if (!items.length) {
          root.innerHTML = '<div class="empty">Henüz favoriniz yok.</div>';
          return;
        }

        root.innerHTML = items.map(cardHTML).join('');

        // Favori kalp butonlarını hydrate et (toggle ile listeden çıkarabilsin)
        if (window.FAV) await FAV.wireFavButtons(root);

      } catch (err) {
        console.error(err);
        $('#favlist').innerHTML = '<div class="pad error">Favoriler alınamadı.</div>';
      }
    }

    document.addEventListener('partials:loaded', load);
    window.addEventListener('DOMContentLoaded', function(){
      if (typeof includePartials === 'function') includePartials();
      // includePartials sonrası 'partials:loaded' tetiklenecek ve load() çağrılacak.
    });
  })();
  </script>
</body>
</html>
