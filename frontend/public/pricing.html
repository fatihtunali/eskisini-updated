<!doctype html>
<html lang="tr">
<head>
  <!-- Google Fonts: Inter (TR uyumlu, latin-ext) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap&subset=latin-ext" rel="stylesheet">

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Fiyatlandırma | Eskisini Ver Yenisini Al</title>
  <link rel="stylesheet" href="/css/styles.css">

  <style>
    /* Basit fiyat kartları */
    .grid.pricing { grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 18px; }
    .pricecard{background:#fff;border:1px solid #e5e7eb;border-radius:14px;padding:16px;display:flex;flex-direction:column}
    .pricecard h3{margin:6px 0 4px;font-size:1.15rem}
    .price{font-size:1.6rem;font-weight:800;margin:6px 0 10px}
    .price .period{font-size:.9rem;font-weight:600;color:#6b7280}
    .plist{list-style:none;padding:0;margin:10px 0;display:grid;gap:6px}
    .plist li{background:#f9fafb;border:1px dashed #e5e7eb;border-radius:10px;padding:8px 10px}
    .pricecard .btn{margin-top:10px}
    .price-free{border-color:#c7f9cc}
    .price-pro{border-color:#a5b4fc}
    .price-business{border-color:#fcd34d}
    .sub.center{color:#6b7280}
  </style>
</head>

<body>
  <div data-include="/partials/header.html"></div>

  <main class="container section" data-billing>
    <h1 class="center">Basit ve Şeffaf Fiyatlandırma</h1>
    <p class="sub center">İhtiyacınıza uygun paketi seçin.</p>
    <div id="plans" class="grid pricing" aria-live="polite"></div>
  </main>

  <div data-include="/partials/footer.html"></div>

  <!-- JS yükleme sırası -->
  <script src="/js/partials.js"></script>
  <script src="/js/config.js"></script>
  <script src="/js/session.js"></script>
  <script src="/js/header.js"></script>

  <!-- ÖNEMLİ: billing.js'i ekle (modal, BillingAPI, BILLING.init burada) -->
  <script src="/js/billing.js"></script>

  <script>
  (async function () {
    // partials (header/footer) yükle
    if (typeof includePartials === 'function') await includePartials();

    const API_BASE = (window.APP && window.APP.API_BASE) || '';
    const $ = (s,r=document)=>r.querySelector(s);
    const money = (m,c='TRY') => new Intl.NumberFormat('tr-TR',{style:'currency',currency:c}).format((Number(m)||0)/100);
    const esc = s => String(s ?? '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]));

    async function getPlans(){
      const r = await fetch(`${API_BASE}/api/billing/plans`, { headers:{'Accept':'application/json'}, credentials:'include' });
      if (!r.ok) throw new Error('HTTP '+r.status);
      return r.json();
    }

    // Seç butonu davranışı: billing.js modalını kullan
    function handleChoose(code){
      if (!window.BILLING) {
        alert('Ödeme modülü yüklenemedi. Lütfen sayfayı yenileyin.');
        return;
      }
      if (code === 'free') {
        // Ücretsiz ise direkt profille devam (plan zaten aktif olabilir)
        location.href = '/profile.html#billing';
        return;
      }
      // Pro veya Business -> modal aç
      window.BILLING.showUpgradeModal(code);
    }

    const wrap = $('#plans');
    wrap.innerHTML = `<div class="pad">Yükleniyor…</div>`;

    try{
      const data = await getPlans();
      const plans = (data && data.plans) ? data.plans : [];

      if (!plans.length){
        wrap.innerHTML = `<div class="pad error">Planlar yüklenemedi.</div>`;
        return;
      }

      wrap.innerHTML = plans.map(p => {
        const perks = Array.isArray(p.perks) ? p.perks : (p.perks ? [p.perks] : []);
        const period = p.period === 'monthly' ? 'ay' : (p.period === 'yearly' ? 'yıl' : p.period || '');
        const css =
          p.code?.includes('pro')      ? 'price-pro' :
          p.code?.includes('business') ? 'price-business' :
                                         'price-free';

        return `
          <article class="pricecard ${css}">
            <h3>${esc(p.name || p.code || 'Plan')}</h3>
            <div class="price">
              ${money(p.price_minor, p.currency || 'TRY')}
              ${period ? `<span class="period">/${esc(period)}</span>` : ``}
            </div>
            <ul class="plist">
              <li>Aylık ilan hakkı: <b>${p.listing_quota_month===9999?'Sınırsız':esc(p.listing_quota_month)}</b></li>
              <li>Yükseltme (bump): <b>${esc(p.bump_credits_month)}</b></li>
              <li>Öne çıkarma: <b>${esc(p.featured_credits_month)}</b></li>
              <li>Destek: <b>${esc(p.support_level || 'none')}</b></li>
              ${perks.map(x=>`<li>✅ ${esc(x)}</li>`).join('')}
            </ul>
            <button class="btn primary" data-plan="${esc(p.code)}">
              ${Number(p.price_minor) ? 'Seç' : 'Ücretsiz seç'}
            </button>
          </article>
        `;
      }).join('');

      // “Seç” tıklamaları
      wrap.addEventListener('click', (e)=>{
        const btn = e.target.closest('button[data-plan]');
        if (!btn) return;
        handleChoose(btn.dataset.plan);
      });
    }catch(err){
      console.error(err);
      wrap.innerHTML = `<div class="pad error">Planlar yüklenemedi.</div>`;
    }
  })();
  </script>
</body>
</html>
