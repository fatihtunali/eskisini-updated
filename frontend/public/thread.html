<!doctype html>
<html lang="tr">
<head>
  <!-- Google Fonts: Inter (TR uyumlu, latin-ext) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap&subset=latin-ext" rel="stylesheet">
  
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mesajlar | Eskisini Ver Yenisini Al</title>
  <meta name="description" content="Eskisini Ver Yenisini Al platformundaki mesajlaşma ekranı." />
  <link rel="stylesheet" href="/css/styles.css" />
  <style>
    .chat {display:flex;flex-direction:column;gap:8px;max-height:60vh;overflow-y:auto;padding:8px;background:#fff;border:1px solid var(--line,#e5e7eb);border-radius:12px}
    .chat-msg {padding:8px 12px;border-radius:12px;max-width:70%}
    .chat-msg.me {align-self:flex-end;background:var(--brand,#ff6a00);color:#fff}
    .chat-msg.other {align-self:flex-start;background:#f3f4f6;color:#111}
    .chat-input {display:flex;gap:8px;margin-top:10px}
    .chat-input input {flex:1;padding:10px;border:1px solid #ddd;border-radius:8px}
  </style>
</head>
<body>
  <!-- HEADER -->
  <div data-include="partials/header.html"></div>

  <!-- MAIN -->
  <main class="container section">
    <h1>Konuşma</h1>
    <div id="msgs" class="chat"></div>
    <form id="send" class="chat-input">
      <input name="body" id="msgBody" placeholder="Mesajınızı yazın..." autocomplete="off" required />
      <button class="btn primary" type="submit">Gönder</button>
    </form>
  </main>

  <!-- FOOTER -->
  <div data-include="partials/footer.html"></div>

  <!-- JS -->
  <script src="/js/partials.js"></script>
  <script src="/js/config.js"></script>
  <script src="/js/api.js"></script>
  <script src="/js/auth.js"></script>
  <script src="/js/session.js"></script>
  <script src="/js/header.js"></script>

  <!-- Sayfaya özel -->
  <script>
  if (typeof includePartials === 'function') includePartials();

  (function(){
    const API = window.APP?.API_BASE || '';
    const $ = (s,r=document)=>r.querySelector(s);

    const msgsEl = $('#msgs');
    const formEl = $('#send');
    const inputEl = $('#msgBody');

    const u = new URL(location.href);
    const threadId = u.searchParams.get('thread');
    if (!threadId) {
      msgsEl.innerHTML = '<div class="pad error">Geçersiz konuşma.</div>';
      return;
    }

    async function loadMessages(){
      msgsEl.innerHTML = '<div class="muted">Yükleniyor...</div>';
      try{
        const res = await fetch(`${API}/api/messages/thread/${encodeURIComponent(threadId)}`, {
          credentials:'include',
          headers:{'Accept':'application/json'}
        });
        if (res.status === 401){ location.href='/login.html?redirect='+encodeURIComponent(location.pathname+location.search); return; }
        if (!res.ok) throw new Error('HTTP '+res.status);
        const data = await res.json();
        const me = data.me_id;
        msgsEl.innerHTML = (data.items||[]).map(m=>{
          const cls = m.sender_id===me ? 'me' : 'other';
          return `<div class="chat-msg ${cls}">${m.body}</div>`;
        }).join('') || '<div class="muted">Henüz mesaj yok.</div>';
        msgsEl.scrollTop = msgsEl.scrollHeight;
      }catch(e){
        console.error(e);
        msgsEl.innerHTML = '<div class="pad error">Mesajlar yüklenemedi.</div>';
      }
    }

    formEl.addEventListener('submit', async ev=>{
      ev.preventDefault();
      const body = inputEl.value.trim();
      if (!body) return;
      try{
        const res = await fetch(`${API}/api/messages/thread/${encodeURIComponent(threadId)}`, {
          method:'POST',
          credentials:'include',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({ body })
        });
        if (!res.ok) throw new Error('HTTP '+res.status);
        inputEl.value='';
        await loadMessages();
      }catch(e){
        alert('Gönderilemedi: '+e.message);
      }
    });

    document.addEventListener('partials:loaded', loadMessages);
  })();
  </script>
</body>
</html>
